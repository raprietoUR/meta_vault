
  
    

        create or replace transient table edw.gen_phase.datasets_fields_0
         as
        (

SELECT TMP.COD_DATASET,TMP.ID_ORDER,TMP.COD_DATASET_FIELD,TMP.COD_TYPE,TMP.COD_COLUMN_NAME_TARGET, '1' SW_TRACK_DIFF, '0' SW_ACTIVE_VALUE_DEFAULT, '' COLUMN_VALUE_DEFAULT_FX, '0' SW_VIRTUAL_FIELD_VALUE, ' Business Description' DESC_BUSINESS_DESCRIPTION
, 0 SW_CLUSTERIZABLE
FROM  edw.raw_data.datasets_fields TMP
INNER JOIN  edw.gen_phase.model_load_runs_last M
 ON TMP.ID_MODEL_RUN=M.ID_MODEL_RUN

UNION 
SELECT 'DS_SG_'||DS.COD_DATASET_ORIGIN, COL.ORDINAL_POSITION::VARCHAR ID_ORDER,  COL.COLUMN_NAME COD_DATASET_FIELD, 'AT' COD_TYPE 
, COL.COLUMN_NAME COD_COLUMN_NAME_TARGET
, '1' SW_TRACK_DIFF, '0' SW_ACTIVE_VALUE_DEFAULT, '' COLUMN_VALUE_DEFAULT_FX, '0' SW_VIRTUAL_FIELD_VALUE, COALESCE(COL.COMMENT,COL.COLUMN_NAME)|| ' Business Description' DESC_BUSINESS_DESCRIPTION
, 0 SW_CLUSTERIZABLE
FROM edw.raw_data.datasets  DS
INNER JOIN  edw.gen_phase.setconnection_connections SC ON DS.COD_SETCONNECTION = SC.COD_SETCONNECTION
INNER JOIN  edw.gen_phase.environment_connections EC ON SC.COD_CONNECTION = EC.COD_CONNECTION AND EC.COD_ENVIRONMENT = 'PRO'
INNER JOIN  edw.gen_phase.connections CN ON EC.COD_CONNECTION = CN.COD_CONNECTION 
INNER JOIN  edw.gen_phase.model_load_runs_last M
 ON DS.ID_MODEL_RUN=M.ID_MODEL_RUN
 LEFT JOIN  edw.gen_phase.datasets_fields_columns COL 		ON DS.COD_DATASET_ORIGIN = COL.TABLE_NAME AND CN.COD_PATH_1 = COL.TABLE_CATALOG AND CN.COD_PATH_2 = COL.TABLE_SCHEMA
 LEFT JOIN edw.raw_data.datasets_fields  DS_FIELDS	ON DS.COD_DATASET = DS_FIELDS.COD_DATASET  	AND COL.COLUMN_NAME = DS_FIELDS.COD_DATASET_FIELD AND DS.ID_MODEL_RUN = DS_FIELDS.ID_MODEL_RUN
 LEFT JOIN edw.raw_data.relationships REL_1  		ON DS.COD_DATASET = REL_1.REFERENCE_COD_DATASET AND COL.COLUMN_NAME = REL_1.REFERENCE_COD_NAME AND DS.ID_MODEL_RUN = REL_1.ID_MODEL_RUN
 LEFT JOIN edw.raw_data.relationships REL_2  		ON DS.COD_DATASET = REL_2.TARGET_COD_DATASET  AND COL.COLUMN_NAME = REL_2.TARGET_COD_NAME AND DS.ID_MODEL_RUN = REL_2.ID_MODEL_RUN
 WHERE
      DS_FIELDS.COD_DATASET_FIELD IS NULL 
 AND REL_1.REFERENCE_COD_DATASET IS NULL
 AND REL_2.TARGET_COD_DATASET IS NULL
        );
      
  