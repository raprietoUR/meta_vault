{{ config(schema='raw_data',
  alias='datasets_fields_columns',
  materialized='incremental') }}
--depends on: {{ ref('RAW_LOAD_MODEL_LOAD_RUNS') }}, {{ ref('RAW_INIT') }}, {{ source('EDW_RAW_DATA', 'datasets_fields_columns_tmp') }}, {{ ref('RAW_INIT') }}
  
	SELECT 	T.TABLE_CATALOG,
			T.TABLE_SCHEMA,
			T.TABLE_NAME,
			T.COLUMN_NAME,
			cast(coalesce(nullif(T.ORDINAL_POSITION			,''),NULL) as NUMERIC) ORDINAL_POSITION,
			T.COLUMN_DEFAULT,
			T.IS_NULLABLE,
			T.DATA_TYPE,
			cast(coalesce(nullif(T.CHARACTER_MAXIMUM_LENGTH	,''),NULL) as NUMERIC) CHARACTER_MAXIMUM_LENGTH,
			cast(coalesce(nullif(T.CHARACTER_OCTET_LENGTH	,''),NULL) as NUMERIC) CHARACTER_OCTET_LENGTH,
			cast(coalesce(nullif(T.NUMERIC_PRECISION		,''),NULL) as NUMERIC) NUMERIC_PRECISION,
			cast(coalesce(nullif(T.NUMERIC_PRECISION_RADIX	,''),NULL) as NUMERIC) NUMERIC_PRECISION_RADIX,
			cast(coalesce(nullif(T.NUMERIC_SCALE			,''),NULL) as NUMERIC) NUMERIC_SCALE,
			cast(coalesce(nullif(T.DATETIME_PRECISION		,''),NULL) as NUMERIC) DATETIME_PRECISION,
			T.INTERVAL_TYPE,
			cast(coalesce(nullif(T.INTERVAL_PRECISION		,''),NULL) as NUMERIC)INTERVAL_PRECISION,
			T.CHARACTER_SET_CATALOG,
			T.CHARACTER_SET_SCHEMA,
			T.CHARACTER_SET_NAME,
			T.COLLATION_CATALOG,
			T.COLLATION_SCHEMA,
			T.COLLATION_NAME,
			T.DOMAIN_CATALOG,
			T.DOMAIN_SCHEMA,
			T.DOMAIN_NAME,
			T.UDT_CATALOG,
			T.UDT_SCHEMA,
			T.UDT_NAME,
			T.SCOPE_CATALOG,
			T.SCOPE_SCHEMA,
			T.SCOPE_NAME,
			cast(coalesce(nullif(T.MAXIMUM_CARDINALITY		,''),NULL) as NUMERIC) MAXIMUM_CARDINALITY,
			T.DTD_IDENTIFIER,
			T.IS_SELF_REFERENCING,
			T.IS_IDENTITY,
			T.IDENTITY_GENERATION,
			T.IDENTITY_START,
			T.IDENTITY_INCREMENT,
			T.IDENTITY_MAXIMUM,
			T.IDENTITY_MINIMUM,
			T.IDENTITY_CYCLE,
			T.COMMENT,
			M.ID_MODEL_RUN,
			M.DT_MODEL_LOAD,
			CURRENT_TIMESTAMP DT_LOAD
	FROM  {{ source('EDW_RAW_DATA', 'datasets_fields_columns_tmp') }} T
LEFT JOIN (SELECT
			COD_MODEL,
			DT_MODEL_LOAD,
			ID_MODEL_RUN,
			ROW_NUMBER() OVER (PARTITION BY COD_MODEL ORDER BY DT_MODEL_LOAD DESC) ULTIMO_REG
		FROM  {{ ref('RAW_LOAD_MODEL_LOAD_RUNS') }} WHERE COD_TYPE_RUN='{{ var('cod_type_run') }}') M
ON M.COD_MODEL= '{{ var('cod_model') }}'
AND M.ULTIMO_REG = 1

