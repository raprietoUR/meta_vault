{{ config(
    schema='gen_phase',
    alias='datasets_fields_0',
    materialized='incremental'
) }}

SELECT TMP.COD_DATASET,TMP.ID_ORDER,TMP.COD_DATASET_FIELD,TMP.COD_TYPE,TMP.COD_COLUMN_NAME_TARGET, '1' SW_TRACK_DIFF, '' COLUMN_VALUE_DEFAULT_FX, 0 SW_VIRTUAL_FIELD_VALUE, ' Business Description' DESC_BUSINESS_DESCRIPTION
FROM  {{ ref('RAW_LOAD_DATASETS_FIELDS') }} TMP
INNER JOIN  {{ ref('GEN_REFRESH_MODEL_LOAD_RUNS_LAST') }} M
 ON TMP.ID_MODEL_RUN=M.ID_MODEL_RUN
{# WHERE
M.COD_TYPE_RUN='{{ var('cod_type_run') }}'
AND M.COD_MODEL= '{{ var('cod_model') }}' #}
UNION 
SELECT 'DS_SG_'||DS.COD_DATASET_ORIGIN, COL.ORDINAL_POSITION::VARCHAR ID_ORDER,  COL.COLUMN_NAME COD_DATASET_FIELD, 'AT' COD_TYPE 
, COL.COLUMN_NAME COD_COLUMN_NAME_TARGET
, '1' SW_TRACK_DIFF, '' COLUMN_VALUE_DEFAULT_FX, 0 SW_VIRTUAL_FIELD_VALUE, COALESCE(COL.COMMENT,COL.COLUMN_NAME)|| ' Business Description' DESC_BUSINESS_DESCRIPTION
FROM {{ ref('RAW_LOAD_DATASETS') }}  DS
INNER JOIN  {{ ref('GEN_LOAD_SETCONNECTION_CONN') }} SC ON DS.COD_SETCONNECTION = SC.COD_SETCONNECTION
INNER JOIN  {{ ref('GEN_LOAD_ENVIRONMENT_CONN') }} EC ON SC.COD_CONNECTION = EC.COD_CONNECTION AND EC.COD_ENVIRONMENT = '{{ var('cod_environment') }}'
INNER JOIN  {{ ref('GEN_LOAD_CONNECTIONS') }} CN ON EC.COD_CONNECTION = CN.COD_CONNECTION 
INNER JOIN  {{ ref('GEN_REFRESH_MODEL_LOAD_RUNS_LAST') }} M
 ON DS.ID_MODEL_RUN=M.ID_MODEL_RUN
 LEFT JOIN  {{ ref('GEN_LOAD_COLUMNS') }} COL 		ON DS.COD_DATASET_ORIGIN = COL.TABLE_NAME AND CN.COD_PATH_1 = COL.TABLE_CATALOG AND CN.COD_PATH_2 = COL.TABLE_SCHEMA
 LEFT JOIN {{ ref('RAW_LOAD_DATASETS_FIELDS') }}  DS_FIELDS	ON DS.COD_DATASET = DS_FIELDS.COD_DATASET  	AND COL.COLUMN_NAME = DS_FIELDS.COD_DATASET_FIELD AND DS.ID_MODEL_RUN = DS_FIELDS.ID_MODEL_RUN
 LEFT JOIN {{ ref('RAW_LOAD_RELATIONSHIPS') }} REL_1  		ON DS.COD_DATASET = REL_1.REFERENCE_COD_DATASET AND DS.ID_MODEL_RUN = REL_1.ID_MODEL_RUN
 LEFT JOIN {{ ref('RAW_LOAD_RELATIONSHIPS') }} REL_2  		ON DS.COD_DATASET = REL_2.TARGET_COD_DATASET  AND DS.ID_MODEL_RUN = REL_2.ID_MODEL_RUN
 WHERE
    {# M.COD_TYPE_RUN='{{ var('cod_type_run') }}'
 AND M.COD_MODEL= '{{ var('cod_model') }}'
 AND #}  DS_FIELDS.COD_DATASET_FIELD IS NULL 
 AND REL_1.REFERENCE_COD_DATASET IS NULL
 AND REL_2.TARGET_COD_DATASET IS NULL
