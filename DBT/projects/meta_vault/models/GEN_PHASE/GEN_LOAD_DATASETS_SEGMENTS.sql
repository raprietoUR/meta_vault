{{ config(schema='gen_phase',
  alias='datasets_segments',
  materialized='incremental') }}

  
  

-- depends on: {{ ref('GEN_INIT') }}

WITH AUTOMATED_DS AS 
(
	SELECT 
	COD_TYPE ID_TYPE_SEGMENT
	,COD_DATASET
	,1 ID_SEGMENT
	,'DS_SG_'||SUBSTRING(COD_DATASET,4) COD_DATASET_CHILD
	,COD_DATASET_NAME
	,SW_GENERATE_FLEXIBLE_SAT
	,SW_LOAD_INITIAL
	,SW_DELETE_DATA_LOADED_SOURCE
	,SW_MATERIALIZED
	,DESC_DATE_SQL_INCREMENTAL_START
	,DESC_DATE_SQL_INCREMENTAL_END
	,DESC_FIELD_INCREMENTAL
	,DESC_FIELD_INCREMENTAL_PATTERN
	,DT_START
	,DT_END
	,DESC_DATASET DESC_BUSINESS_DEFINITION
	,COD_CLUSTERIZATION
	,ID_MODEL_RUN
	,DT_MODEL_LOAD
	,CURRENT_TIMESTAMP DT_LOAD	
FROM {{ ref('RAW_LOAD_DATASETS') }} 
WHERE SW_AUTOMATED_DV = '1'
)
,DATATASETS_ALL AS 
(
	SELECT TMP.ID_MODEL_RUN,
		TMP.ID_TYPE_SEGMENT,
		TMP.COD_DATASET,
		TMP.ID_SEGMENT,
		TMP.COD_DATASET_CHILD,
		TMP.COD_DATASET_NAME,
		TMP.SW_GENERATE_FLEXIBLE_SAT,
		TMP.SW_LOAD_INITIAL,
		TMP.SW_DELETE_DATA_LOADED_SOURCE,
		TMP.SW_MATERIALIZED,
		TMP.DESC_DATE_SQL_INCREMENTAL_START,
		TMP.DESC_DATE_SQL_INCREMENTAL_END,
		TMP.DESC_FIELD_INCREMENTAL,
		TMP.DESC_FIELD_INCREMENTAL_PATTERN,
		TMP.DT_START,
		TMP.DT_END,
		TMP.DESC_BUSINESS_DEFINITION
		,TMP.COD_CLUSTERIZATION 
	FROM  {{ ref('RAW_LOAD_DATASETS_SEGMENTS') }} TMP
	UNION 
	SELECT  TMP.ID_MODEL_RUN,
		TMP.ID_TYPE_SEGMENT,
		TMP.COD_DATASET,
		TMP.ID_SEGMENT,
		TMP.COD_DATASET_CHILD,
		TMP.COD_DATASET_NAME,
		TMP.SW_GENERATE_FLEXIBLE_SAT,
		TMP.SW_LOAD_INITIAL,
		TMP.SW_DELETE_DATA_LOADED_SOURCE,
		TMP.SW_MATERIALIZED,
		TMP.DESC_DATE_SQL_INCREMENTAL_START,
		TMP.DESC_DATE_SQL_INCREMENTAL_END,
		TMP.DESC_FIELD_INCREMENTAL,
		TMP.DESC_FIELD_INCREMENTAL_PATTERN,
		TMP.DT_START,
		TMP.DT_END,
		TMP.DESC_BUSINESS_DEFINITION
		,TMP.COD_CLUSTERIZATION
	FROM AUTOMATED_DS TMP
	)

SELECT TMP.ID_TYPE_SEGMENT,
TMP.COD_DATASET,
TMP.ID_SEGMENT,
TMP.COD_DATASET_CHILD,
TMP.COD_DATASET_NAME,
TMP.SW_GENERATE_FLEXIBLE_SAT,
TMP.SW_LOAD_INITIAL,
TMP.SW_DELETE_DATA_LOADED_SOURCE,
TMP.SW_MATERIALIZED,
TMP.DESC_DATE_SQL_INCREMENTAL_START,
TMP.DESC_DATE_SQL_INCREMENTAL_END,
TMP.DESC_FIELD_INCREMENTAL,
TMP.DESC_FIELD_INCREMENTAL_PATTERN,
TMP.DT_START,
TMP.DT_END,
TMP.DESC_BUSINESS_DEFINITION
,TMP.COD_CLUSTERIZATION
FROM  DATATASETS_ALL TMP
INNER JOIN  {{ ref('GEN_REFRESH_MODEL_LOAD_RUNS_LAST') }} M
 ON TMP.ID_MODEL_RUN=M.ID_MODEL_RUN
WHERE
M.COD_TYPE_RUN='{{ var('cod_type_run') }}'
AND M.COD_MODEL= '{{ var('cod_model') }}'
